#!/bin/bash

# 获取用户输入
read -p "请输入 Web 面板端口（默认 54321）: " PORT
PORT=${PORT:-54321}
read -p "请输入登录用户名（默认 admin）: " USERNAME
USERNAME=${USERNAME:-admin}
read -p "请输入登录密码（默认 admin）: " PASSWORD
PASSWORD=${PASSWORD:-admin}

# 更新软件包
echo "更新软件包..."
apt update && apt upgrade -y

# 安装依赖
echo "安装必需的依赖..."
apt install -y curl wget tar python3-pkg-resources

# 下载 x-ui
echo "下载 x-ui..."
curl -Ls https://github.com/vaxilu/x-ui/releases/download/0.3.2/x-ui-linux-amd64.tar.gz -o /tmp/x-ui-linux-amd64.tar.gz
tar -zxvf /tmp/x-ui-linux-amd64.tar.gz -C /usr/local/
rm -f /tmp/x-ui-linux-amd64.tar.gz

# 配置 x-ui
echo "配置 x-ui..."
cd /usr/local/x-ui
chmod +x x-ui
cp x-ui.sh /usr/bin/x-ui

# 设置用户名和密码
echo "设置登录用户名和密码..."
/usr/bin/x-ui set username $USERNAME
/usr/bin/x-ui set password $PASSWORD
/usr/bin/x-ui set port $PORT

# 创建启动命令
echo "创建启动命令..."
mkdir -p /var/log/x-ui

# 使用 nohup 启动 x-ui
echo "使用 nohup 启动 x-ui..."
nohup /usr/bin/x-ui > /var/log/x-ui/x-ui.log 2>&1 &

# 获取后台进程的 PID
PID=$!
echo "x-ui 服务已启动，PID: $PID"
echo "日志输出到 /var/log/x-ui/x-ui.log"

# 确保 nohup 启动时命令在后台运行
echo "x-ui 启动成功！可以通过以下命令查看日志："
echo "tail -f /var/log/x-ui/x-ui.log"
