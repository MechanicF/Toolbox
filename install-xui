#!/bin/bash

# 获取用户输入
read -p "请输入 Web 面板端口（默认 54321）: " PORT
PORT=${PORT:-54321}
read -p "请输入登录用户名（默认 admin）: " USERNAME
USERNAME=${USERNAME:-admin}
read -p "请输入登录密码（默认 admin）: " PASSWORD
PASSWORD=${PASSWORD:-admin}

# 更新软件包
echo "更新软件包..."
apt update && apt upgrade -y

# 安装依赖
echo "安装必需的依赖..."
apt install -y curl wget tar python3-pkg-resources

# 下载 x-ui
echo "下载 x-ui..."
curl -Ls https://github.com/vaxilu/x-ui/releases/download/0.3.2/x-ui-linux-amd64.tar.gz -o /tmp/x-ui-linux-amd64.tar.gz
tar -zxvf /tmp/x-ui-linux-amd64.tar.gz -C /usr/local/
rm -f /tmp/x-ui-linux-amd64.tar.gz

# 配置 x-ui
echo "配置 x-ui..."
cd /usr/local/x-ui
chmod +x x-ui
cp x-ui.sh /usr/bin/x-ui

# 设置用户名和密码
echo "设置登录用户名和密码..."
/usr/bin/x-ui set username $USERNAME
/usr/bin/x-ui set password $PASSWORD
/usr/bin/x-ui set port $PORT

# 创建 systemd 服务文件
echo "创建 systemd 服务文件..."
cat <<EOF > /etc/systemd/system/x-ui.service
[Unit]
Description=x-ui service
After=network.target

[Service]
ExecStart=/usr/bin/x-ui
WorkingDirectory=/usr/local/x-ui
Restart=always
User=root
Group=root
Environment=PATH=/usr/bin:/usr/local/bin
Environment=USER=root
Environment=HOME=/root

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd 服务
echo "重新加载 systemd 服务..."
systemctl daemon-reload

# 启动并启用 x-ui 服务
echo "启动并启用 x-ui 服务..."
systemctl enable x-ui
systemctl start x-ui

# 查看服务状态
echo "查看 x-ui 服务状态..."
systemctl status x-ui
