#!/bin/bash

set -e

green='\033[0;32m'
yellow='\033[0;33m'
red='\033[0;31m'
plain='\033[0m'

echo -e "${green}x-ui å®¹å™¨é€‚é…å®‰è£…è„šæœ¬ï¼ˆå« supervisord ç®¡ç†ï¼‰${plain}"

# 1. è¾“å…¥é¢æ¿ç«¯å£
read -p "è¯·è¾“å…¥ Web é¢æ¿ç«¯å£ï¼ˆé»˜è®¤ 54321ï¼‰: " input_port
panel_port=${input_port:-54321}
if ! [[ "$panel_port" =~ ^[0-9]+$ ]]; then
  echo -e "${red}ç«¯å£å¿…é¡»ä¸ºæ•°å­—ï¼${plain}"
  exit 1
fi

# 2. è¾“å…¥ç”¨æˆ·å
read -p "è¯·è¾“å…¥ç™»å½•ç”¨æˆ·åï¼ˆé»˜è®¤ adminï¼‰: " input_user
panel_user=${input_user:-admin}

# 3. è¾“å…¥å¯†ç 
read -p "è¯·è¾“å…¥ç™»å½•å¯†ç ï¼ˆé»˜è®¤ adminï¼‰: " input_pass
panel_pass=${input_pass:-admin}

# 4. å®‰è£…ä¾èµ–
apt update
apt install -y curl wget tar supervisor

# 5. æ¶æ„åˆ¤æ–­
arch=$(uname -m)
if [[ $arch == "x86_64" || $arch == "amd64" ]]; then
  ARCH="amd64"
elif [[ $arch == "aarch64" || $arch == "arm64" ]]; then
  ARCH="arm64"
else
  echo -e "${red}æœªçŸ¥æ¶æ„ $archï¼Œé»˜è®¤ä½¿ç”¨ amd64${plain}"
  ARCH="amd64"
fi

# 6. ä¸‹è½½ x-ui
cd /usr/local
VERSION=$(curl -s https://api.github.com/repos/vaxilu/x-ui/releases/latest | grep tag_name | cut -d '"' -f4)
wget -O x-ui-linux-${ARCH}.tar.gz https://github.com/vaxilu/x-ui/releases/download/${VERSION}/x-ui-linux-${ARCH}.tar.gz
tar zxvf x-ui-linux-${ARCH}.tar.gz
rm -f x-ui-linux-${ARCH}.tar.gz

chmod +x /usr/local/x-ui/x-ui
chmod +x /usr/local/x-ui/bin/xray-linux-${ARCH}

# 7. ä¸‹è½½æ§åˆ¶è„šæœ¬
wget -O /usr/bin/x-ui https://raw.githubusercontent.com/vaxilu/x-ui/main/x-ui.sh
chmod +x /usr/bin/x-ui

# 8. è®¾ç½®è´¦å·ã€å¯†ç ã€ç«¯å£
/usr/local/x-ui/x-ui setting -username "$panel_user" -password "$panel_pass"
/usr/local/x-ui/x-ui setting -port "$panel_port"

# 9. é…ç½® supervisor
cat > /etc/supervisor/conf.d/x-ui.conf <<EOF
[program:x-ui]
command=/usr/local/x-ui/x-ui
directory=/usr/local/x-ui/
autostart=true
autorestart=true
stderr_logfile=/var/log/x-ui.err.log
stdout_logfile=/var/log/x-ui.out.log
EOF

# 10. å¯åŠ¨æœåŠ¡
supervisorctl reread
supervisorctl update
supervisorctl start x-ui

# 11. è¾“å‡ºä¿¡æ¯
echo -e ""
echo -e "${green}âœ… x-ui å®‰è£…å®Œæˆï¼${plain}"
echo -e "ğŸŒ è®¿é—®åœ°å€: http://<ä½ çš„IP>:${yellow}${panel_port}${plain}"
echo -e "ğŸ‘¤ ç”¨æˆ·å: ${yellow}${panel_user}${plain}"
echo -e "ğŸ” å¯†ç : ${yellow}${panel_pass}${plain}"
echo -e "ğŸ“Œ è¿è¡Œæ–¹å¼: supervisord ç®¡ç†"
echo -e "â–¶ï¸ æŸ¥çœ‹çŠ¶æ€: ${green}supervisorctl status x-ui${plain}"
